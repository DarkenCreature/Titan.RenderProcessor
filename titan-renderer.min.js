class TitanRenderProcessor{errorCodes=[{code:"TTN-RP-091",descr:"TTN-RP-091: expressions are not allowed for binding of value attributes! Element:"}];getErrMsg(t){return this.errorCodes.filter((e=>e.code==t))[0].descr}contexts=[{tag:"bind-text",method:"bindText"},{tag:"bind-raw",method:"bindRaw"},{tag:"bind-class",method:"bindClass"},{tag:"bind-attribute",method:"bindAttribute"},{tag:"bind-value",method:"bindValue"},{tag:"bind-style",method:"bindStyle"},{tag:"bind-click",method:"bindClickEvent"},{tag:"bind-change",method:"bindChangeEvent"}];renderComponent(t,e=null){t.querySelectorAll("[bind-rerender]").forEach((r=>{r.template=r.innerHTML,t.registerEvent(r.getAttribute("bind-rerender"),{tgtElement:r,callBack:t=>{t.innerHTML=t.template;var r=t.closest("[ttn-role]"),i=null==e?null==r.data?r.dataObj:r.data:e;(new TitanRenderProcessor).render(t,i)}}),r.removeAttribute("bind-rerender")})),this.render(t,null==e?null==t.data?t.dataObj:t.data:e,null)}render(t,e,r=null){for(null==r&&(r=[]),"object"==typeof e&&r.push(e);null!=t.querySelector("[for-each]");)this.renderForEachLoops(t.querySelector("[for-each]"),e,r);this.renderBindings(t,e,r)}renderBindings(t,e,r){var i=this;t.querySelectorAll("[if]:not([for-each])").forEach((t=>i.renderIf(t,e,r))),this.contexts.forEach((n=>{t.hasAttribute(n.tag)&&i[n.method](t,e,r),t.querySelectorAll(`[${n.tag}]`).forEach((t=>i[n.method](t,e,r)))}))}renderIf(t,e,r){var i=t.getAttribute("if");this.dissolveBinding(i,t,e,r)?t.removeAttribute("if"):t.parentElement.removeChild(t)}renderForEachLoops(t,e,r){var i=t.getAttribute("for-each"),n=t.hasAttribute("if")?t.getAttribute("if"):null,s=t.parentElement;s.template=s.innerHTML,s.tempForEachTemplate=t.outerHTML,t.removeAttribute("for-each"),t.removeAttribute("if");var a=[];r.forEach((t=>{a.push(t)}));var l=e;"$"==i?(l=e,a.push(e)):i.indexOf("$")>-1?l=e[i.split("$")[1]]:i.split(".").forEach((t=>{l=l[t],a.push(l)}));l.forEach((e=>{if(!0,null==n||this.dissolveBinding(n,r,e,a)){t.insertAdjacentHTML("beforebegin",s.tempForEachTemplate);var r=s.querySelector("[for-each]");r.removeAttribute("for-each"),r.removeAttribute("if"),this.render(r,e,a),this.renderBindings(r,e,a)}})),s.removeChild(t),this.renderBindings(s,e,a)}bindText(t,e,r){var i=t.getAttribute("bind-text"),n=this.dissolveBinding(i,t,e,r);t.innerText=n,t.removeAttribute("bind-text")}bindRaw(t,e,r){var i=t.getAttribute("bind-raw"),n=this.dissolveBinding(i,t,e,r);t.innerHTML=n,t.removeAttribute("bind-raw")}bindClass(t,e,r){var i=t.getAttribute("bind-class"),n=this.dissolveBinding(i,t,e,r);""!=(n??"")&&t.classList.add(n),t.removeAttribute("bind-class")}bindAttribute(t,e,r){var i=t.getAttribute("bind-attribute"),n=this.dissolveBinding(i,t,e,r);""!=(n??"")&&("object"==typeof n||"array"==typeof n?t.setAttribute(n[0],n[1]):t.setAttribute(n,"")),t.removeAttribute("bind-attribute")}bindValue(t,e,r){var i=t.getAttribute("bind-value");if("{"==i.substring(0,1))this.errorCodes.filter((t=>{})),console.error(`TTN-RP-091: ${this.getErrMsg("TTN-RP-091")}`,t);else{var n=this.dissolveBinding(i,t,e,r);""!=(n??"")&&(t.value=n),t.$__binding={context:"$"==i?r[r.length-1]:e,index:"$"==i?r[r.length-1].indexOf(n):null,path:i};var s={context:t.$__binding.context,property:t.$__binding.index??t.$__binding.path,object:t},a=t.closest("[ttn-role]").$__stateManager.bindedVariables;0==a.filter((t=>{})).length&&a.push(s),t.addEventListener("change",(function(){null==this.$__binding.index?this.$__binding.context[this.$__binding.path]=this.value:this.$__binding.context[this.$__binding.index]=this.value}))}t.removeAttribute("bind-value")}bindStyle(t,e,r){var i=t.getAttribute("bind-style"),n=this.dissolveBinding(i,t,e,r);""!=(n??"")&&t.setAttribute("style",t.hasAttribute("style")?t.getAttribute("style")+" "+n:n),t.removeAttribute("bind-style")}dissolveBinding(t,e,r,i){return"{"==t.substring(0,1)?this.getBindingExpression(r,i,t):this.getBindingValue(r,i,t)}getBindingExpression(c,cH,path){var regex=/\[[A-Z|a-z|0-9|.|\/| ]{0,99}\]/g,matches=path.match(regex);return null!=matches&&matches.forEach((t=>{var e=this.getBindingValue(c,cH,t.slice(1,-1));"string"==typeof e&&(e=`'${e}'`),path=path.replace(t,e)})),path=path.replace("$","string"==typeof c?`${c}`:c),eval(path.slice(1,-1))}getBindingValue(t,e,r){if("$"==r)return t??"";var i=(r.match(/.\//g)||[]).length;if(r=r.replaceAll("./",""),0==i)try{return t[r]??""}catch{return""}else try{return e[e.length-1-i][r]??""}catch{return""}}fetchArgs(t,e,r){null!=t.getAttribute("args")&&t.getAttribute("args").split(",").forEach((i=>{var n=i,s=null;2==i.split("=").length?(n=i.split("=")[0],s=this.dissolveBinding(i.split("=")[1],null,e,r)):s=this.dissolveBinding(i,null,e,r),t.$__clickHandler.args[n]=s}))}bindClickEvent(t,e,r){var i=t.getAttribute("bind-click"),n=this.dissolveBinding(i,t,e,r);n||"{"==i.substring(0,1)||(n=i),null!=n&&""!=n&&(t.$__clickHandler={method:n,target:t.closest(`[ttn-role="${t.getAttribute("bind-target")??"component"}"]`),args:{}},this.fetchArgs(t,e,r),t.addEventListener("click",(function(){this.$__clickHandler.target[this.$__clickHandler.method](this,this.$__clickHandler.args)})),t.style.cursor="pointer"),t.removeAttribute("bind-click"),t.removeAttribute("bind-target"),t.removeAttribute("args")}bindChangeEvent(t,e,r){var i=t.getAttribute("bind-change"),n=this.dissolveBinding(i,t,e,r);n||"{"==i.substring(0,1)||(n=i),null!=n&&""!=n&&(t.$__clickHandler={method:n,target:t.closest(`[ttn-role="${t.getAttribute("bind-target")??"component"}"]`),args:{}},this.fetchArgs(t,e,r),t.addEventListener("change",(function(){this.$__clickHandler.args.value=this.value,this.$__clickHandler.target[this.$__clickHandler.method](this,this.$__clickHandler.args)})),t.style.cursor="pointer"),t.removeAttribute("bind-change"),t.removeAttribute("bind-target"),t.removeAttribute("args")}}class TitanComponent extends HTMLElement{constructor(){super(),this._state={},this.$__eventSheduler=[],this.$__stateManager={bindedVariables:[]}}getRemoveAttribute(t){var e=this.getAttribute(t);return this.removeAttribute(t),e}raiseEvent(t){null!=this.$__eventSheduler[t]&&this.$__eventSheduler[t].forEach((t=>{t.callBack(t.tgtElement)}))}registerEvent(t,e){null==this.$__eventSheduler[t]&&(this.$__eventSheduler[t]=[]),this.$__eventSheduler[t].push(e)}connectedCallback(){this.preInitialRender(),this.render()}preInitialRender(){this.hasAttribute("[ttn-role]")||this.setAttribute("ttn-role","component")}preSetProp(t,e,r){return!0}postSetProp(t,e,r){}refreshBindings(t,e,r){this.$__stateManager.bindedVariables.filter((r=>r.property==e&&JSON.stringify(t)==JSON.stringify(r.context))).forEach((t=>{t.object.value=r}))}createDeepProxy(t,e=null){return new Proxy(t,{path:"test",get:(t,e)=>{const r=t[e];return r&&"object"==typeof r?this.createDeepProxy(r,t):r},set:(t,e,r)=>(this.preSetProp(t,e,r)&&(t[e]=r),this.refreshBindings(t,e,r),this.postSetProp(t,e,r),!0)})}}
