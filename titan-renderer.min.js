class TitanRenderProcessor{renderComponent(e,t=null){e.querySelectorAll("[bind-rerender]").forEach((t=>{t.template=t.innerHTML,e.registerEvent(t.getAttribute("bind-rerender"),{tgtElement:t,callBack:e=>{e.innerHTML=e.template,(new TitanRenderProcessor).render(e,e.closest("[ttn-role]").data,null)}}),t.removeAttribute("bind-rerender")})),this.render(e,null==t?e.data:t,null)}render(e,t,r=null){for(null==r&&(r=[]),"object"==typeof t&&r.push(t);null!=e.querySelector("[for-each]");)this.renderForEachLoops(e.querySelector("[for-each]"),t,r);this.renderBindings(e,t,r)}renderBindings(e,t,r){var i=this;e.querySelectorAll("[if]:not([for-each])").forEach((e=>i.renderIf(e,t,r))),[{tag:"bind-text",method:"bindText"},{tag:"bind-raw",method:"bindRaw"},{tag:"bind-class",method:"bindClass"},{tag:"bind-attribute",method:"bindAttribute"},{tag:"bind-value",method:"bindValue"},{tag:"bind-style",method:"bindStyle"},{tag:"bind-click",method:"bindClickEvent"},{tag:"bind-change",method:"bindChangeEvent"}].forEach((n=>{e.hasAttribute(n.tag)&&i[n.method](e,t,r),e.querySelectorAll(`[${n.tag}]`).forEach((e=>i[n.method](e,t,r)))}))}renderIf(e,t,r){var i=e.getAttribute("if");this.dissolveBinding(i,e,t,r)?e.removeAttribute("if"):e.parentElement.removeChild(e)}renderForEachLoops(e,t,r){var i=e.getAttribute("for-each"),n=e.hasAttribute("if")?e.getAttribute("if"):null,s=e.parentElement;s.template=s.innerHTML,s.tempForEachTemplate=e.outerHTML,e.removeAttribute("for-each"),e.removeAttribute("if");var l=[];r.forEach((e=>{l.push(e)}));var a=t;"$"==i?a=t:i.indexOf("$")>-1?a=t[i.split("$")[1]]:(i.split(".").forEach((e=>{l.push(a[e]),a=a[e]})),l.pop()),l.push(a),a.forEach((t=>{if(null==n||this.dissolveBinding(n,r,t,l)){e.insertAdjacentHTML("beforebegin",s.tempForEachTemplate);var r=s.querySelector("[for-each]");r.removeAttribute("for-each"),r.removeAttribute("if"),this.render(r,t,l),this.renderBindings(r,t,l)}})),s.removeChild(e),this.renderBindings(s,t,l)}bindText(e,t,r){var i=e.getAttribute("bind-text"),n=this.dissolveBinding(i,e,t,r);e.innerText=n,e.removeAttribute("bind-text")}bindRaw(e,t,r){var i=e.getAttribute("bind-raw"),n=this.dissolveBinding(i,e,t,r);e.innerHTML=n,e.removeAttribute("bind-raw")}bindClass(e,t,r){var i=e.getAttribute("bind-class"),n=this.dissolveBinding(i,e,t,r);""!=(n??"")&&e.classList.add(n),e.removeAttribute("bind-class")}bindAttribute(e,t,r){var i=e.getAttribute("bind-attribute"),n=this.dissolveBinding(i,e,t,r);""!=(n??"")&&e.setAttribute(n,""),e.removeAttribute("bind-attribute")}bindValue(e,t,r){var i=e.getAttribute("bind-value"),n=this.dissolveBinding(i,e,t,r);""!=(n??"")&&(e.value=n),e.removeAttribute("bind-value")}bindStyle(e,t,r){var i=e.getAttribute("bind-style"),n=this.dissolveBinding(i,e,t,r);""!=(n??"")&&e.setAttribute("style",e.hasAttribute("style")?e.getAttribute("style")+" "+n:n),e.removeAttribute("bind-style")}dissolveBinding(e,t,r,i){return"{"==e.substring(0,1)?this.getBindingExpression(r,i,e):this.getBindingValue(r,i,e)}getBindingExpression(context,contextHistory,path){var regex=/\[[A-Z|a-z|0-9|.|\/| ]{0,99}\]/g,matches=path.match(regex);return null!=matches&&matches.forEach((e=>{var t=this.getBindingValue(context,contextHistory,e.slice(1,-1));"string"==typeof t&&(t=`'${t}'`),path=path.replace(e,t)})),eval(path.slice(1,-1))}getBindingValue(e,t,r){if("$"==r)return e??"";var i=(r.match(/.\//g)||[]).length;if(r=r.replaceAll("./",""),0==i)try{return e[r]??""}catch{return""}else try{return t[t.length-1-i][r]??""}catch{return""}}bindChangeEvent(e,t,r){var i=e.getAttribute("bind-change"),n=this.dissolveBinding(i,e,t,r);n||"{"==i.substring(0,1)||(n=i),null!=n&&""!=n&&(e.clickHandler={method:n,target:e.closest(`[ttn-role="${e.getAttribute("bind-target")??"component"}"]`),args:{}},this.fetchArgs(e,t,r),e.addEventListener("change",(function(){this.clickHandler.args.value=this.value,this.clickHandler.target[this.clickHandler.method](this,this.clickHandler.args)})),e.style.cursor="pointer"),e.removeAttribute("bind-change"),e.removeAttribute("bind-target"),e.removeAttribute("args")}fetchArgs(e,t,r){null!=e.getAttribute("args")&&e.getAttribute("args").split(",").forEach((i=>{var n=i,s=null;2==i.split("=").length?(n=i.split("=")[0],s=this.getBindingValue(t,r,i.split("=")[1])):s=this.getBindingValue(t,r,i),e.clickHandler.args[n]=s}))}bindClickEvent(e,t,r){var i=e.getAttribute("bind-click"),n=this.dissolveBinding(i,e,t,r);n||"{"==i.substring(0,1)||(n=i),null!=n&&""!=n&&(e.clickHandler={method:n,target:e.closest(`[ttn-role="${e.getAttribute("bind-target")??"component"}"]`),args:{}},this.fetchArgs(e,t,r),e.addEventListener("click",(function(){this.clickHandler.target[this.clickHandler.method](this,this.clickHandler.args)})),e.style.cursor="pointer"),e.removeAttribute("bind-click"),e.removeAttribute("bind-target"),e.removeAttribute("args")}}class TitanComponent extends HTMLElement{constructor(){super(),this._state={},this.$__eventSheduler=[]}getRemoveAttribute(e){var t=this.getAttribute(e);return this.removeAttribute(e),t}raiseEvent(e){null!=this.$__eventSheduler[e]&&this.$__eventSheduler[e].forEach((e=>{e.callBack(e.tgtElement)}))}registerEvent(e,t){null==this.$__eventSheduler[e]&&(this.$__eventSheduler[e]=[]),this.$__eventSheduler[e].push(t)}connectedCallback(){this.preRender(),this.render()}preRender(){this.hasAttribute("[ttn-role]")||this.setAttribute("ttn-role","component")}createDeepProxy(e,t=null){return new Proxy(e,{get:(e,t)=>{const r=e[t];return r&&"object"==typeof r?this.createDeepProxy(r,e):r},set:(e,t,r)=>(e[t]=r,this.render(),!0)})}}
