class TitanRenderProcessor{errorCodes=[{code:"TTN-RP-091",descr:"TTN-RP-091: expressions are not allowed for binding of value attributes! Element:"}];getErrMsg(t){return this.errorCodes.filter((e=>e.code==t))[0].descr}contexts=[{tag:"bind-text",method:"bindText"},{tag:"bind-raw",method:"bindRaw"},{tag:"bind-class",method:"bindClass"},{tag:"bind-attribute",method:"bindAttribute"},{tag:"bind-value",method:"bindValue"},{tag:"bind-style",method:"bindStyle"},{tag:"bind-click",method:"bindClickEvent"},{tag:"bind-change",method:"bindChangeEvent"}];renderComponent(t,e=null){null==e&&null==t.data&&(t.data=t.createDeepProxy(t.$__state.data)),t.querySelectorAll("[bind-rerender]").forEach((i=>{i.template=i.innerHTML,t.registerEvent(i.getAttribute("bind-rerender"),{tgtElement:i,callBack:t=>{t.innerHTML=t.template;var i=t.closest("[ttn-role]"),r=null==e?i.data:e;(new TitanRenderProcessor).render(t,r)}}),i.removeAttribute("bind-rerender")})),this.render(t,null==e?t.data:e)}render(t,e,i=null){for(null==i&&(i=[]),"object"==typeof e&&i.push(e);null!=t.querySelector("[for-each]");)this.renderForEachLoops(t.querySelector("[for-each]"),e,i);this.renderBindings(t,e,i)}renderBindings(t,e,i){var r=this;t.querySelectorAll("[if]:not([for-each])").forEach((t=>r.renderIf(t,e,i))),this.contexts.forEach((n=>{t.hasAttribute(n.tag)&&r[n.method](t,e,i),t.querySelectorAll(`[${n.tag}]`).forEach((t=>r[n.method](t,e,i)))}))}renderIf(t,e,i){var r=t.getAttribute("if");this.dissolveBinding(r,t,e,i)?t.removeAttribute("if"):t.parentElement.removeChild(t)}renderForEachLoops(t,e,i){var r=t.getAttribute("for-each"),n=t.hasAttribute("if")?t.getAttribute("if"):null,s=t.parentElement;s.template=s.innerHTML,s.tempForEachTemplate=t.outerHTML,t.removeAttribute("for-each"),t.removeAttribute("if");var a=[];i.forEach((t=>{a.push(t)}));var d=e;"$"==r?(d=e,a.push(e)):r.indexOf("$")>-1?d=e[r.split("$")[1]]:r.split(".").forEach((t=>{d=d[t],a.push(d)}));d.forEach((e=>{if(!0,null==n||this.dissolveBinding(n,i,e,a)){t.insertAdjacentHTML("beforebegin",s.tempForEachTemplate);var i=s.querySelector("[for-each]");i.removeAttribute("for-each"),i.removeAttribute("if"),this.render(i,e,a),this.renderBindings(i,e,a)}})),s.removeChild(t),this.renderBindings(s,e,a)}bindText(t,e,i){var r=t.getAttribute("bind-text"),n=this.dissolveBinding(r,t,e,i);this.createBindings(t,e,i,"bind-text","innerText"),t.innerText=n,t.removeAttribute("bind-text")}bindRaw(t,e,i){var r=t.getAttribute("bind-raw"),n=this.dissolveBinding(r,t,e,i);this.createBindings(t,e,i,"bind-raw","innerHTML"),t.innerHTML=n,t.removeAttribute("bind-raw")}bindClass(t,e,i){var r=t.getAttribute("bind-class"),n=this.dissolveBinding(r,t,e,i);this.createBindings(t,e,i,"bind-class","class"),t.bindedClass=n,""!=(n??"")&&t.classList.add(n),t.removeAttribute("bind-class")}bindAttribute(t,e,i){var r=t.getAttribute("bind-attribute"),n=this.dissolveBinding(r,t,e,i);this.createBindings(t,e,i,"bind-attribute","attribute"),""!=(n??"")&&("object"==typeof n||"array"==typeof n?(t.bindedAttribute=n[0],t.setAttribute(n[0],n[1])):(t.bindedAttribute=n,t.setAttribute(n,""))),t.removeAttribute("bind-attribute")}createBindings(t,e,i,r,n){t.$__binding={context:"$"==t.getAttribute(r)?i[i.length-1]:e,index:"$"==t.getAttribute(r)?i[i.length-1].indexOf(n):null,path:t.getAttribute(r),target:n};var s=t.getAttribute(r).match(/\[[A-Z|a-z|0-9|.|\/| ]{0,99}\]/g);null!=s?s.forEach((e=>{this.registerBinding(t,e.slice(1,-1))})):this.registerBinding(t,t.getAttribute(r))}registerBinding(t,e){var i={context:t.$__binding.context,property:e,target:t.$__binding.target,path:t.$__binding.path,object:t},r=t.closest("[ttn-role]").$__stateManager.bindedVariables;0==r.filter((t=>{})).length&&r.push(i)}bindValue(t,e,i){var r=t.getAttribute("bind-value");if("{"==r.substring(0,1))this.errorCodes.filter((t=>{})),console.error(`TTN-RP-091: ${this.getErrMsg("TTN-RP-091")}`,t);else{var n=this.dissolveBinding(r,t,e,i);""!=(n??"")&&(t.value=n),this.createBindings(t,e,i,"bind-value","value"),t.addEventListener("change",(function(){null==this.$__binding.index?this.$__binding.context[this.$__binding.path]=this.value:this.$__binding.context[this.$__binding.index]=this.value}))}t.removeAttribute("bind-value")}bindStyle(t,e,i){var r=t.getAttribute("bind-style"),n=this.dissolveBinding(r,t,e,i);""!=(n??"")&&t.setAttribute("style",t.hasAttribute("style")?t.getAttribute("style")+" "+n:n),t.removeAttribute("bind-style")}dissolveBinding(t,e,i,r){return"{"==t.substring(0,1)?this.getBindingExpression(i,r,t):this.getBindingValue(i,r,t)}getBindingExpression(c,cH,path){var regex=/\[[A-Z|a-z|0-9|.|\/| ]{0,99}\]/g,matches=path.match(regex);return null!=matches&&matches.forEach((t=>{var e=this.getBindingValue(c,cH,t.slice(1,-1));"string"==typeof e&&(e=`'${e}'`),path=path.replace(t,e)})),path=path.replace("$","string"==typeof c?`${c}`:c),eval(path.slice(1,-1))}getBindingValue(t,e,i){if("$"==i)return t??"";var r=(i.match(/.\//g)||[]).length;if(i=i.replaceAll("./",""),0==r)try{return t[i]??""}catch{return""}else try{return e[e.length-1-r][i]??""}catch{return""}}fetchArgs(t,e,i){null!=t.getAttribute("args")&&t.getAttribute("args").split(",").forEach((r=>{var n=r,s=null;2==r.split("=").length?(n=r.split("=")[0],s=this.dissolveBinding(r.split("=")[1],null,e,i)):s=this.dissolveBinding(r,null,e,i),t.$__clickHandler.args[n]=s}))}bindClickEvent(t,e,i){var r=t.getAttribute("bind-click"),n=this.dissolveBinding(r,t,e,i);n||"{"==r.substring(0,1)||(n=r),null!=n&&""!=n&&(t.$__clickHandler={method:n,target:t.closest(`[ttn-role="${t.getAttribute("bind-target")??"component"}"]`),args:{}},this.fetchArgs(t,e,i),t.addEventListener("click",(function(){this.$__clickHandler.target[this.$__clickHandler.method](this,this.$__clickHandler.args)})),t.style.cursor="pointer"),t.removeAttribute("bind-click"),t.removeAttribute("bind-target"),t.removeAttribute("args")}bindChangeEvent(t,e,i){var r=t.getAttribute("bind-change"),n=this.dissolveBinding(r,t,e,i);n||"{"==r.substring(0,1)||(n=r),null!=n&&""!=n&&(t.$__clickHandler={method:n,target:t.closest(`[ttn-role="${t.getAttribute("bind-target")??"component"}"]`),args:{}},this.fetchArgs(t,e,i),t.addEventListener("change",(function(){this.$__clickHandler.args.value=this.value,this.$__clickHandler.target[this.$__clickHandler.method](this,this.$__clickHandler.args)})),t.style.cursor="pointer"),t.removeAttribute("bind-change"),t.removeAttribute("bind-target"),t.removeAttribute("args")}}class TitanComponent extends HTMLElement{constructor(){super(),this.$__state={data:{}},this.$__eventSheduler=[],this.$__stateManager={renderer:new TitanRenderProcessor,bindedVariables:[]}}getRemoveAttribute(t){var e=this.getAttribute(t);return this.removeAttribute(t),e}raiseEvent(t){null!=this.$__eventSheduler[t]&&this.$__eventSheduler[t].forEach((t=>{t.callBack(t.tgtElement)}))}registerEvent(t,e){null==this.$__eventSheduler[t]&&(this.$__eventSheduler[t]=[]),this.$__eventSheduler[t].push(e)}connectedCallback(){this.preInitialRender(),this.render()}preInitialRender(){this.hasAttribute("[ttn-role]")||this.setAttribute("ttn-role","component")}preSetProp(t,e,i){return!0}postSetProp(t,e,i){}refreshBindings(t,e,i){this.$__stateManager.bindedVariables.filter((i=>i.property==e&&JSON.stringify(t)==JSON.stringify(i.context))).forEach((t=>{switch(t.target){case"class":null!=t.object.bindedClass&&t.object.classList.remove(t.object.bindedClass);var e=this.$__stateManager.renderer.dissolveBinding(t.path,t.context,t.context,t.context);null!=e&&""!=e&&(t.object.classList.add(e),t.object.bindedClass=e);break;case"attribute":null!=t.object.bindedAttribute&&t.object.removeAttribute(t.object.bindedAttribute);var i=this.$__stateManager.renderer.dissolveBinding(t.path,t.context,t.context,t.context);""!=(i??"")&&("object"==typeof i||"array"==typeof i?(t.object.bindedAttribute=i[0],t.object.setAttribute(i[0],i[1])):(t.object.bindedAttribute=i,t.object.setAttribute(i,"")));break;default:t.object[t.target]=this.$__stateManager.renderer.dissolveBinding(t.path,t.context,t.context,t.context)}}))}createDeepProxy(t,e=null){return new Proxy(t,{path:"test",get:(t,e)=>{const i=t[e];return i&&"object"==typeof i?this.createDeepProxy(i,t):i},set:(t,e,i)=>(this.preSetProp(t,e,i)&&(t[e]=i),this.refreshBindings(t,e,i),this.postSetProp(t,e,i),!0)})}}
